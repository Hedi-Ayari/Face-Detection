name: AI Code Review

on: [push, pull_request]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: AI Code Review
        run: |
          # Get the diff safely (text only, no binary)
          if [ "${{ github.event_name }}" = "push" ]; then
            DIFF=$(git diff --text HEAD~1)
          else
            DIFF=$(git diff --text HEAD~1)
          fi

          if [ -n "$DIFF" ]; then
            echo "üîç Reviewing changes..."

            # Use jq instead of Python for fast JSON escaping
            SAFE_DIFF=$(jq -Rs . <<< "$DIFF")

            echo "‚úÖ Submitting diff to API..."
            curl -s -X POST "http://84.247.166.227:3000/pre-commit-review" \
              -H "Content-Type: application/json" \
              -d "{\"diff\": $SAFE_DIFF, \"repoUrl\": \"https://github.com/${{ github.repository }}\"}" \
              --fail

            echo "‚úÖ Diff sent successfully."
          else
            echo "‚úÖ No changes to review."
          fi
        env:
          API_KEY: ${{ secrets.AI_REVIEW_API_KEY }}
