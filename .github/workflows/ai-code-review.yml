name: AI Code Review
on: [push, pull_request]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: AI Code Review
        run: |
          # Get the diff safely
          if [ "${{ github.event_name }}" = "push" ]; then
            DIFF=$(git diff HEAD~1 2>/dev/null || git show --format= --name-only)
          else
            DIFF=$(git diff HEAD~1 2>/dev/null || git show --format= --name-only)
          fi

          if [ -n "$DIFF" ]; then
            echo "Reviewing changes..."
            # Escape newlines and quotes for JSON
            SAFE_DIFF=$(echo "$DIFF" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
            echo "Diff to be sent: $SAFE_DIFF"
            curl -X POST "http://84.247.166.227:3000/pre-commit-review" \
              -H "Content-Type: application/json" \
              -d "{\"diff\": $SAFE_DIFF, \"repoUrl\": \"https://github.com/${{ github.repository }}\"}" \
              --fail
          else
            echo "No changes to review"
          fi
        env:
          API_KEY: ${{ secrets.AI_REVIEW_API_KEY }}
